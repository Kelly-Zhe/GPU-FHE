import numpy as np
import math
def vec_add(a, b, MOD):
    assert a.shape == b.shape
    return (a + b) % MOD

def vec_sub(a, b, MOD):
    assert a.shape == b.shape
    return (a - b) % MOD

def vec_mul(a, b, MOD):
    assert a.shape == b.shape
    return (a * b) % MOD

def NTT(x):
    return x

def iNTT(x):
    return x

def reverse_bits(num, msb):
    msbb = (msb >> 3) + (1 if msb & 0x7 else 0)

    def reverse_byte(byte):
        return int('{:08b}'.format(byte)[::-1], 2)

    shift_trick = {
        0: 0,
        1: 7,
        2: 6,
        3: 5,
        4: 4,
        5: 3,
        6: 2,
        7: 1
    }

    if msbb == 1:
        return (reverse_byte(num & 0xff) >> shift_trick[msb & 0x7])
    elif msbb == 2:
        return (reverse_byte(num & 0xff) << 8 | reverse_byte((num >> 8) & 0xff)) >> shift_trick[msb & 0x7]
    elif msbb == 3:
        return (reverse_byte(num & 0xff) << 16 | reverse_byte((num >> 8) & 0xff) << 8 |reverse_byte((num >> 16) & 0xff)) >> shift_trick[msb & 0x7]
    elif msbb == 4:
        return (reverse_byte(num & 0xff) << 24 | reverse_byte((num >> 8) & 0xff) << 16 |reverse_byte((num >> 16) & 0xff) << 8 | reverse_byte((num >> 24) & 0xff)) >> shift_trick[msb & 0x7]
    else:
        return -1
        # Handle the case for msbb values greater than 4 if necessary.


def precompute_auto_map(n, k, precomp):
    m = n << 1  # cyclOrder
    logm = int(math.log2(m))
    logn = int(math.log2(n))
    for j in range(n):
        j_tmp = ((j << 1) + 1)
        idx = ((j_tmp * k) - (((j_tmp * k) >> logm) << logm)) >> 1
        jrev = reverse_bits(j, logn)
        idxrev = reverse_bits(idx, logn)
        precomp[jrev] = idxrev

def AutomorphismTransform_with_precom(ra, a, n, precomp_vec):
    for j in range(n):
        ra[j] = a[precomp_vec[j]]

def test_reverse_bits():
    # Example usage:
    num = 0b1111111000111001
    msb = 16
    print( format(num, '16b') )
    print(format(reverse_bits(num, msb), '16b'))

    num = 0b1010101010101010
    print( format(num, '16b') )
    print(format(reverse_bits(num, msb), '16b'))

def test_precompute_auto_map():
    n = 512
    k = 25
    precomp = np.zeros(n, dtype = 'uint64')
    precompute_auto_map(n, k, precomp)

    golden_answer = np.array([
        96,97,98,99,100,101,102,103,105,104,107,106,109,108,111,110,115,114,112,113,119,118,116,117,122,123,121,120,126,127,125,124,86,87,85,84,81,80,83,82,95,94,92,93,88,89,90,91,76,77,78,79,74,75,73,72,67,66,64,65,71,70,68,69,28,29,30,31,26,27,25,24,19,18,16,17,23,22,20,21,0,1,2,3,4,5,6,7,9,8,11,10,13,12,15,14,57,56,59,58,61,60,63,62,52,53,54,55,50,51,49,48,38,39,37,36,33,32,35,34,47,46,44,45,40,41,42,43,248,249,250,251,252,253,254,255,245,244,247,246,243,242,240,241,231,230,228,229,224,225,226,227,238,239,237,236,233,232,235,234,193,192,195,194,197,196,199,198,200,201,202,203,204,205,206,207,210,211,209,208,214,215,213,212,219,218,216,217,223,222,220,221,138,139,137,136,142,143,141,140,135,134,132,133,128,129,130,131,152,153,154,155,156,157,158,159,149,148,151,150,147,146,144,145,173,172,175,174,171,170,168,169,162,163,161,160,166,167,165,164,190,191,189,188,185,184,187,186,176,177,178,179,180,181,182,183,328,329,330,331,332,333,334,335,325,324,327,326,323,322,320,321,347,346,344,345,351,350,348,349,342,343,341,340,337,336,339,338,366,367,365,364,361,360,363,362,352,353,354,355,356,357,358,359,380,381,382,383,378,379,377,376,371,370,368,369,375,374,372,373,290,291,289,288,294,295,293,292,299,298,296,297,303,302,300,301,304,305,306,307,308,309,310,311,313,312,315,314,317,316,319,318,277,276,279,278,275,274,272,273,284,285,286,287,282,283,281,280,270,271,269,268,265,264,267,266,256,257,258,259,260,261,262,263,468,469,470,471,466,467,465,464,477,476,479,478,475,474,472,473,463,462,460,461,456,457,458,459,449,448,451,450,453,452,455,454,497,496,499,498,501,500,503,502,504,505,506,507,508,509,510,511,490,491,489,488,494,495,493,492,487,486,484,485,480,481,482,483,442,443,441,440,446,447,445,444,439,438,436,437,432,433,434,435,420,421,422,423,418,419,417,416,429,428,431,430,427,426,424,425,387,386,384,385,391,390,388,389,394,395,393,392,398,399,397,396,401,400,403,402,405,404,407,406,408,409,410,411,412,413,414,415
    ], dtype = 'uint64')
    
    compare = np.array_equal(precomp, golden_answer)
    print(compare)

def test_AutomorphismTransform_with_precom():
    n = 512
    index = 25
    precomp = np.zeros(n, dtype='uint64')
    input = np.array([
        681793666716418992,948072974289206014,223698001890857589,617772402358229029,940918236628890577,1023334382350255805,601276993330270557,802650149361347524,878665008122916167,455665307968405481,322031686518444716,175315950327353036,386659019623829400,1053807846008220893,801429701553647580,1017495991906939657,1102098014873189925,118899280239498533,70225728916016437,727621141693085353,237273073830006804,441665125694059487,1060669414242282052,1070603293061149186,1150331865469960233,376025982097906802,189045518537865772,225970307824361373,658135949763686370,578781332138179474,39032427012832428,425161867610416206,565049850736593638,719427517852289798,130217055795831036,231033438754760799,58874485817677803,639929689985427627,787005699116977484,1126468991606204119,891027207547934441,466636413642204361,220768010027746331,177263055419148108,242917250868167333,70363654029709184,180834358013961074,938793954018793362,66420656607551310,469685100055125846,456936256436090203,865315338802017606,690108951642235555,319482529163343774,979138283576359495,926796721561019786,641263930855742452,603556256810745009,912877864705356111,142643253483529201,1151688092314753766,984594197057495130,617610451791452244,657354823497888535,308441539478328781,153560416918854420,53091914867898491,804469225360496381,398768169613247792,684624503992675126,421697364321259142,202942149899606591,330492829625324636,291458884287602225,577495837774663722,52539747471804756,762753427890660291,615719273214448282,492523824613178351,145691586978497475,286870259953677923,151335594544729227,67732387055406573,992210873791261621,1000611110484784780,512097932324976372,72070721645579801,322712978781862996,488259136435149834,985939191118663522,928203164718916932,1085739388065011169,493644556286033110,440999812093701383,778168811745364005,602322300334914516,665430007129342343,618974458532330559,377479142754032600,938655831917712202,36922118884555851,212460088050665147,178647525305455322,803772449925494608,664631820258020998,978103646085274456,274977956885041743,967103800760885134,336813427927210312,1125791549359447107,830815748277926580,835017510751855282,198583270128801243,454733514836719740,118440733269519466,724662373055388817,560975675084949733,595226293241642002,218145263290013169,436370160863382395,990614822142292554,15161159045152489,775714227551447890,852829817428637715,955418012279461809,688578643787111617,158092464199238288,1150559820391936820,721817027693529395,644629240570932557,1049381246625017697,51186916270209628,548361734936944162,905292967374905845,1150309172664971469,628624593068297973,1013194427421482013,553602324068365126,907455997168215053,134919378678416988,268886981615821927,304582784273558178,1100314562423891925,59024270509424744,1127718986405643665,902577967076720861,1027411094532460640,122738830954735662,298413497612188165,326243320202309524,148800676302471871,882806641465264233,221836291380599083,596743775966230292,636404918126163541,555998930193063716,259583502976844965,989438264779370886,529712094040280075,789751125049878683,432667412989497943,867439195383909478,497347359563238219,244341998480336298,1026855392848877597,385814850453338355,217309512158837016,599944632415707390,947625594909831705,43060301249483397,970079309480268685,774745651657978714,113003540115260692,181867921199175729,466607181631087822,166354318315653922,619506995592361507,343124823733760065,419893516052942974,221288008145697799,664118834525597682,91914943685465675,295307029151827943,788394529337627565,846078576495099659,123826382700708463,435495954743650328,667600583331999587,199380489143694444,1090232463838597562,480007468067424460,721485011450355092,79553659908376536,532114286866919591,181725077354403945,339152960429328910,95491958987661864,889281234886102771,1145143679821739582,97856181926562211,1138824234497141391,918561558536213732,344930598294890347,899600748905442433,378850347875083015,323328274528609420,1107122902422666230,392347714406125762,865062789522358508,1496073149830974,50449980912698374,242660599380889492,532245803131986239,302009261124553440,782865172270788942,524574448197860965,838353206854018317,297252558131621893,537829006360284780,304153010979170594,130716678294397326,887279698941331310,820804786053553265,999155354854731162,1088499763979336767,87549685334193229,874536462861926868,796696115644807556,893645064338566499,299209166404211960,736968873593325239,372472108212289239,612215931870162621,944034855543564416,550415531917423066,1087010153223815068,568256167670032998,142813313980684723,387366473532135027,697670510389277516,496006090337212871,444651202422916544,958023801455001924,205546879782539005,866028718043742843,619458041549182619,143194230436286018,979290678892885686,1105522187232750219,1008377727813651276,943949950597370563,206889244735887669,301092475928804497,67362613760706048,744530939884445100,945788021691422489,232852367803496180,360187969147000336,965289712840022292,385319071282218079,238637179320429758,743179875071874922,758131355790749819,565389765220611023,142108775653281822,37668274205465448,611052655160292351,83961208797341642,286141267429212170,481811951571490398,613548372807835459,61692792751711361,696047249029314160,406193974114233108,423302630973864544,130414112238730520,169378347307968670,643453721106592388,515574967001501774,364670468656335832,801146972697242721,240376993854319456,1060454408873428625,775469884036361186,518531145130581626,600552712296811600,228018919627969467,90613983503544285,498689777658402977,693107263769715315,916299886730311591,703035300159592336,1042171429960927383,225384102551251706,995297880708610779,948853353538084054,610169082717322668,1086237315318384079,3833380519890270,448003176186234011,100196046874607614,225863164412609623,149207320533389603,966187540629574977,177881132791188486,908247040910355877,655309368047594307,1077702788347522581,1068446192091361791,818023745630654563,181009454837258362,812030758029811441,702068541745450208,355092543020239059,852875969351767258,524610993809465638,531073105645229358,45788663148872744,1027859361437725016,1032956915911656808,131396590026275917,234277155559533534,313756281723842438,68331256260477441,79064234859259887,350242758945765619,995092171978435937,582183840693608772,952761743141531483,1027023548026721878,550276220580539441,576006198034925531,43258039697852564,646866584993727480,907753678115843190,265791790504594247,101988261918674292,345677785513276939,1031851925036070911,448110417144318399,95346750494045031,62675133768301991,918856924386735870,785111110013891228,1115301356746748341,1121632942704704424,421986090172636172,35783829471128078,937743571341134612,959025365578933522,525740886646639943,397963701575425476,716066696575425501,442553925444494997,259052444023924907,876458042548885640,713113000796900318,339140477519613069,777820876931940642,806196836127585047,21407369920198657,680620966896187382,325924831421246475,621147626520639933,133639378215726818,1076467439206100446,629896576596591,1033210457363586975,668561360970948403,378057914634005452,901804141193632830,781228382730116826,561288860684917390,824911001855924104,21187849397545137,80029536693317884,948442989457735587,217874239655342353,254167395150333610,676635209461097280,949782259090803673,686888858400111430,688239438011488891,931504277985738457,306096003673012093,436046540725926452,962383360258200177,884100164372540830,898320180245632897,745368315806065141,870054130091389421,118810031352285114,90659313643598062,594954167570797387,339259620993667878,717757542595421804,551177079422132946,548100747135008010,1012580798003743987,287120195878259447,836152312483268266,145882395140207574,660449146037880448,449665945369276649,607041310425416123,971096036090384178,258323754674291422,867723672057299253,23394697197138366,860361821902238238,147052063361896800,664831402767105493,748841740813289519,297646452634545752,1005824264740149480,156318442052959289,456241625239212565,509486634652975789,756321834575114222,361587375108611248,1123694462487764423,284091400355688417,237356538546433838,304905611303652857,1064274576769150465,491972129787993943,598784123249456714,1105907692566469198,1060096921205852055,729365351475204423,1002006259598998199,810814392883912779,856399769720387916,730376291214894036,547551558952341210,818492242922711189,827707727542833703,828282760948274902,853272704753267445,1057737517913469819,619256971013278498,480723925261041251,386684308457726320,480046684545390609,922352436785679645,259513579833324107,835707871202498448,1012350672066311923,729646697479818080,786639946772195,1030271724000576023,554478967476393515,104882123760073484,1087437155789883283,1048724520075170434,932807686177405310,414676770922285180,169389822366890332,364202973005765372,860649263078604079,424653729527666625,550187260615309326,583258912292636153,809294984839983723,879074392331016436,224424271002464741,211853927644379101,789329422727736188,443110045280608590,646563685935825128,49331312150146027,85901228608383108,824711056498836506,721106730518638944,1126715931237709469,255012511887637350,885403536206610287,563633497206459016,638862500961344617,1008820219876552772,589235738721836093,419722669248401929,625771981513095518,323727799113348562,369259343328263650,559587136209183309,461298405170241258,256474900737873640,922364492740067397,857623379791085357,298368720169698348,347340883204612034,1091032884664380227,614673134252936013,403292747295816316,887483139622601029,875765297395005222,1092738760421775237,260510076549022348,908740188239426213,225762302252247903,443137755121356919,526063794933793662,434556992531906022,445684731470906425,231669990849627164,305042352271844631,329689892299258854,308128330320859666,364459434899697102,909713589738600434,605714358931745692,
    ], dtype="uint64")
    output = np.zeros(512, dtype = "uint64")
    golden_answer = np.array([
        665430007129342343,618974458532330559,377479142754032600,938655831917712202,36922118884555851,212460088050665147,178647525305455322,803772449925494608,978103646085274456,664631820258020998,967103800760885134,274977956885041743,1125791549359447107,336813427927210312,835017510751855282,830815748277926580,724662373055388817,118440733269519466,198583270128801243,454733514836719740,436370160863382395,218145263290013169,560975675084949733,595226293241642002,775714227551447890,852829817428637715,15161159045152489,990614822142292554,158092464199238288,1150559820391936820,688578643787111617,955418012279461809,72070721645579801,322712978781862996,512097932324976372,1000611110484784780,151335594544729227,286870259953677923,992210873791261621,67732387055406573,602322300334914516,778168811745364005,493644556286033110,440999812093701383,488259136435149834,985939191118663522,928203164718916932,1085739388065011169,762753427890660291,615719273214448282,492523824613178351,145691586978497475,577495837774663722,52539747471804756,291458884287602225,330492829625324636,804469225360496381,53091914867898491,308441539478328781,153560416918854420,202942149899606591,421697364321259142,398768169613247792,684624503992675126,658135949763686370,578781332138179474,39032427012832428,425161867610416206,189045518537865772,225970307824361373,376025982097906802,1150331865469960233,727621141693085353,70225728916016437,1102098014873189925,118899280239498533,1070603293061149186,1060669414242282052,237273073830006804,441665125694059487,681793666716418992,948072974289206014,223698001890857589,617772402358229029,940918236628890577,1023334382350255805,601276993330270557,802650149361347524,455665307968405481,878665008122916167,175315950327353036,322031686518444716,1053807846008220893,386659019623829400,1017495991906939657,801429701553647580,603556256810745009,641263930855742452,142643253483529201,912877864705356111,984594197057495130,1151688092314753766,657354823497888535,617610451791452244,690108951642235555,319482529163343774,979138283576359495,926796721561019786,456936256436090203,865315338802017606,469685100055125846,66420656607551310,787005699116977484,1126468991606204119,639929689985427627,58874485817677803,719427517852289798,565049850736593638,231033438754760799,130217055795831036,938793954018793362,180834358013961074,242917250868167333,70363654029709184,891027207547934441,466636413642204361,220768010027746331,177263055419148108,1105522187232750219,1008377727813651276,943949950597370563,206889244735887669,301092475928804497,67362613760706048,744530939884445100,945788021691422489,619458041549182619,866028718043742843,979290678892885686,143194230436286018,205546879782539005,958023801455001924,496006090337212871,444651202422916544,372472108212289239,736968873593325239,893645064338566499,299209166404211960,1088499763979336767,87549685334193229,874536462861926868,796696115644807556,387366473532135027,697670510389277516,142813313980684723,568256167670032998,944034855543564416,612215931870162621,1087010153223815068,550415531917423066,532114286866919591,79553659908376536,339152960429328910,181725077354403945,889281234886102771,95491958987661864,97856181926562211,1145143679821739582,1138824234497141391,918561558536213732,344930598294890347,899600748905442433,378850347875083015,323328274528609420,1107122902422666230,392347714406125762,50449980912698374,242660599380889492,1496073149830974,865062789522358508,782865172270788942,524574448197860965,302009261124553440,532245803131986239,304153010979170594,537829006360284780,838353206854018317,297252558131621893,999155354854731162,820804786053553265,130716678294397326,887279698941331310,907455997168215053,134919378678416988,553602324068365126,1013194427421482013,1100314562423891925,59024270509424744,304582784273558178,268886981615821927,628624593068297973,1150309172664971469,548361734936944162,905292967374905845,721817027693529395,644629240570932557,1049381246625017697,51186916270209628,221836291380599083,596743775966230292,636404918126163541,555998930193063716,259583502976844965,989438264779370886,529712094040280075,789751125049878683,326243320202309524,298413497612188165,882806641465264233,148800676302471871,122738830954735662,1027411094532460640,1127718986405643665,902577967076720861,181867921199175729,113003540115260692,166354318315653922,466607181631087822,774745651657978714,970079309480268685,947625594909831705,43060301249483397,497347359563238219,244341998480336298,867439195383909478,432667412989497943,217309512158837016,599944632415707390,385814850453338355,1026855392848877597,480007468067424460,721485011450355092,1090232463838597562,199380489143694444,123826382700708463,846078576495099659,667600583331999587,435495954743650328,619506995592361507,343124823733760065,419893516052942974,221288008145697799,664118834525597682,91914943685465675,295307029151827943,788394529337627565,952761743141531483,1027023548026721878,550276220580539441,576006198034925531,43258039697852564,646866584993727480,907753678115843190,265791790504594247,350242758945765619,79064234859259887,582183840693608772,995092171978435937,68331256260477441,313756281723842438,131396590026275917,234277155559533534,35783829471128078,421986090172636172,1115301356746748341,1121632942704704424,397963701575425476,525740886646639943,937743571341134612,959025365578933522,918856924386735870,785111110013891228,62675133768301991,95346750494045031,345677785513276939,101988261918674292,448110417144318399,1031851925036070911,629896576596591,1033210457363586975,1076467439206100446,133639378215726818,680620966896187382,21407369920198657,621147626520639933,325924831421246475,716066696575425501,442553925444494997,259052444023924907,876458042548885640,713113000796900318,339140477519613069,777820876931940642,806196836127585047,949782259090803673,686888858400111430,688239438011488891,931504277985738457,254167395150333610,676635209461097280,217874239655342353,948442989457735587,781228382730116826,901804141193632830,668561360970948403,378057914634005452,80029536693317884,21187849397545137,561288860684917390,824911001855924104,916299886730311591,703035300159592336,693107263769715315,498689777658402977,995297880708610779,948853353538084054,225384102551251706,1042171429960927383,448003176186234011,3833380519890270,610169082717322668,1086237315318384079,966187540629574977,149207320533389603,100196046874607614,225863164412609623,177881132791188486,908247040910355877,655309368047594307,1077702788347522581,1068446192091361791,818023745630654563,181009454837258362,812030758029811441,355092543020239059,702068541745450208,524610993809465638,852875969351767258,45788663148872744,531073105645229358,1032956915911656808,1027859361437725016,643453721106592388,169378347307968670,364670468656335832,515574967001501774,130414112238730520,423302630973864544,696047249029314160,406193974114233108,518531145130581626,600552712296811600,228018919627969467,90613983503544285,1060454408873428625,775469884036361186,240376993854319456,801146972697242721,613548372807835459,61692792751711361,481811951571490398,286141267429212170,37668274205465448,142108775653281822,83961208797341642,611052655160292351,232852367803496180,360187969147000336,965289712840022292,385319071282218079,238637179320429758,743179875071874922,758131355790749819,565389765220611023,443110045280608590,646563685935825128,49331312150146027,85901228608383108,211853927644379101,789329422727736188,224424271002464741,879074392331016436,563633497206459016,885403536206610287,1008820219876552772,638862500961344617,255012511887637350,1126715931237709469,824711056498836506,721106730518638944,809294984839983723,583258912292636153,424653729527666625,550187260615309326,414676770922285180,169389822366890332,364202973005765372,860649263078604079,786639946772195,729646697479818080,554478967476393515,1030271724000576023,1087437155789883283,104882123760073484,932807686177405310,1048724520075170434,1092738760421775237,875765297395005222,908740188239426213,260510076549022348,443137755121356919,225762302252247903,434556992531906022,526063794933793662,445684731470906425,231669990849627164,305042352271844631,329689892299258854,308128330320859666,364459434899697102,909713589738600434,605714358931745692,298368720169698348,347340883204612034,857623379791085357,922364492740067397,403292747295816316,887483139622601029,614673134252936013,1091032884664380227,256474900737873640,461298405170241258,369259343328263650,559587136209183309,589235738721836093,419722669248401929,625771981513095518,323727799113348562,386684308457726320,480046684545390609,480723925261041251,619256971013278498,835707871202498448,1012350672066311923,259513579833324107,922352436785679645,1057737517913469819,853272704753267445,827707727542833703,828282760948274902,856399769720387916,730376291214894036,547551558952341210,818492242922711189,1123694462487764423,284091400355688417,237356538546433838,304905611303652857,756321834575114222,361587375108611248,509486634652975789,456241625239212565,729365351475204423,1060096921205852055,810814392883912779,1002006259598998199,1105907692566469198,598784123249456714,1064274576769150465,491972129787993943,884100164372540830,962383360258200177,306096003673012093,436046540725926452,118810031352285114,870054130091389421,898320180245632897,745368315806065141,339259620993667878,717757542595421804,594954167570797387,90659313643598062,1012580798003743987,287120195878259447,548100747135008010,551177079422132946,145882395140207574,836152312483268266,449665945369276649,660449146037880448,971096036090384178,607041310425416123,867723672057299253,258323754674291422,23394697197138366,860361821902238238,147052063361896800,664831402767105493,748841740813289519,297646452634545752,1005824264740149480,156318442052959289,
    ], dtype='uint64')
    precompute_auto_map(n, index, precomp)
    AutomorphismTransform_with_precom(output, input, n, precomp)

    print('\n')
    # print("golden_answer.size:")
    # print(golden_answer.size, end='\n')
    # print("input.size")
    # print (input.size, end='\n')
    compare = np.array_equal(output, golden_answer)
    print(compare)